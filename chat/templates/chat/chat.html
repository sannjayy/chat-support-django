{% extends 'base.html' %}
{% load static %}
{% block title %}Chat Session{% endblock title %}
{% block head%}
    <link rel="stylesheet" href="{% static 'assets/css/chat_style.css' %}">
{% endblock head %}
{% block content %}
<header class="page-header">
    <div class="container ">
        <h4>qSupport <a href="{% url 'chat:end_chat' session.session %}" title="End this conversation"  onClick="return confirm('are you sure you want to close this conversation?');"><i class="far fa-window-close" style="color:#f74d4d"></i></a></h4>
        <small>
            {% if user.is_staff %}
                <p>Chatting with : {{session.user.nickname}}</p>
            {% else %}
                <p>Chatting with : {{session.agent.nickname}}</p>
            {% endif %}
        </small>
    </div>
</header>
<div class="main">
    <div class="container ">
        <div class="chat-log" id="display">
            {% comment %} <div class="chat-log__item">
                <h3 class="chat-log__author">Felipe <small>14:30</small></h3>
                <div class="chat-log__message">Yo man</div>
            </div>
            <div class="chat-log__item chat-log__item--own">
                <h3 class="chat-log__author">Fabr√≠cio <small>14:30</small></h3>
                <div class="chat-log__message">BRB</div>
            </div>
            <div id="display"></div> {% endcomment %}
        </div>
    </div>
</div>
<div class="chat-form">
    <div class="container ">        
        <form class="form-horizontal" id="post-form">
            {% csrf_token %}
            <div class="row">
                <div class="col-sm-10 col-xs-8">
                    <input type="text" class="form-control" name="message" id="message" placeholder="Message" />
                </div>
                <div class="col-sm-2 col-xs-4">
                    <button type="submit" class="btn btn-success btn-block">Send</button>
                </div>
            </div>
            
            {% if user.is_staff %}
            <div class="row">
                {% for msg in chat_templates %}
                <div class="col-sm-2 m-3" style="border:1px solid gray; border-radius:50px">
                   <a href="#!" onclick="copyText('{{msg}}')">{{msg|truncatewords:'5'}}</a>
                </div>
                {% endfor %}                
            </div>
            {% endif %}
        </form>
    </div>
</div>

{% endblock content %}
{% block scripts %}
<script>
const copyText = (txt) => {
    $('#message').val(txt)
}
</script>
<script>
$(document).ready(function(){
    const url = window.location.href
    const text = url.match(/\w+/g)
    const session_id = text[text.length - 1];

    setInterval(function(){
        $.ajax({
            type: 'GET',
            url : "/chat/getMessages/"+session_id,
            success: function(response){
                //console.log(response);
                $("#display").empty();
                for (var key in response.messages)
                {
                    if(response.messages[key].is_mine){
                        var temp = "<div class='chat-log__item chat-log__item--own'><h3 class='chat-log__author'>"+response.messages[key].sender+" <small>"+response.messages[key].sent_at+"</small></h3> <div class='chat-log__message'>"+response.messages[key].message+"</div></div>"
                    } else {
                        var temp = "<div class='chat-log__item'><h3 class='chat-log__author'>"+response.messages[key].sender+" <small>"+response.messages[key].sent_at+"</small></h3><div class='chat-log__message'>"+response.messages[key].message+"</div></div>"
                    }
                    $("#display").append(temp);
                }
            },
            error: function(response){
                alert('An error occured')
            }
        });
        window.scrollTo(0,document.body.scrollHeight);

    }, 1000);
})
</script>
<script type="text/javascript">
  $(document).on('submit','#post-form',function(e){
    e.preventDefault();

    $.ajax({
      type:'POST',
      url:'/chat/sendMessage',
      data:{
            message:$('#message').val(),
            url: window.location.href,
            csrfmiddlewaretoken:$('input[name=csrfmiddlewaretoken]').val(),
      },
      success: function(data){
        window.scrollTo(0,document.body.scrollHeight);
         //alert(data)
        //console.log(data)
      }
    });
    document.getElementById('message').value = ''
  });
</script>
{% endblock scripts %}